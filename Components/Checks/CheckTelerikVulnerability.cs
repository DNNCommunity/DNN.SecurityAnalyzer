using System;
using System.Collections.Generic;
using System.IO;
using DotNetNuke.Common;
using DotNetNuke.Common.Utilities;
using Assembly = System.Reflection.Assembly;

namespace DNN.Modules.SecurityAnalyzer.Components.Checks
{
    public class CheckTelerikVulnerability : IAuditCheck
    {
        public CheckResult Execute()
        {
            var result = new CheckResult(SeverityEnum.Unverified, "CheckTelerikVulnerability");

            var fileSums = new List<string>
            {
                "a376fcf4c5899669aa9fe4254c231df6", //Telerik 2013.2.717.40
                "17DDA5D11D88B7ABC8365AEE2D2290E8"  //Telerik 2013.2.717.35
            };
            const string settingName = "Telerik.AsyncUpload.ConfigurationEncryptionKey";
            var compareVersion = new Version(2017, 2, 621);
            var filePath = Path.Combine(Globals.ApplicationMapPath, "bin\\Telerik.Web.UI.dll");
            result.Severity = SeverityEnum.Pass;

            if (File.Exists(filePath))
            {
                var assemblyVersion = Assembly.LoadFile(filePath).GetName().Version;
                if ((assemblyVersion < compareVersion && !fileSums.Contains(Utility.GetFileCheckSum(filePath))))
                {
                    result.Severity = SeverityEnum.Failure;
                    result.Notes.Add("Telerik.Web.UI.dll assembly is not patched.");
                }

                if (string.IsNullOrEmpty(Config.GetSetting(settingName)))
                {
                    result.Severity = SeverityEnum.Failure;
                    result.Notes.Add("App Setting \"Telerik.AsyncUpload.ConfigurationEncryptionKey\" doesn't exist in web.config.");
                }
            }
            else
            {
                result.Notes.Add("Telerik component is not installed in this site.");
            }

            return result;
        }
    }
}